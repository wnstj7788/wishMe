pipeline {
    agent any
    stages {
        stage('Git Clone') {
            steps {
                script {
                    git branch: 'master',
                    url: 'https://github.com/wnstj7788/wishMe.git',
                    credentialsId: 'github_wishme_access_clone'
                }
            }
            post {
                success {
                    echo "Successfully Cloned Repository"
                }
                failure {
                    echo "Failed to Clone Repository"
                }
            }
        }

//         stage('SonarQube analysis') {
//             steps {
//                 withSonarQubeEnv('oci_sonar') {
//                     script {
//                         // React 프로젝트 분석
//                         dir('/var/jenkins_home/workspace/wishme/client/') {
//                             sh 'npm install'
//                             sh 'npm install -g sonarqube-scanner'
//                             sh 'sonar-scanner'
//                         }
//
//                         // Spring 프로젝트 분석
//                         analyzeSonarQube('myLetter')
//                         analyzeSonarQube('schoolLetter')
//                         analyzeSonarQube('user')
//                     }
//                 }
//             }
//         }

        stage('Application') {
            steps {
                script {
                    sh 'cp /var/jenkins_home/workspace/appFile/application.myLetter.yml /var/jenkins_home/workspace/wishme/server/myLetter/src/main/resources/'
                    sh 'cp /var/jenkins_home/workspace/appFile/application.schoolLetter.yml /var/jenkins_home/workspace/wishme/server/user/src/main/resources/'
                    sh 'cp /var/jenkins_home/workspace/appFile/application.user.yml /var/jenkins_home/workspace/wishme/server/schoolLetter/src/main/resources/'
                }
            }
        }

        stage('Build') {
            steps {
                dir('/var/jenkins_home/workspace/wishme/server/myLetter') {
                    sh 'chmod +x gradlew'
                    sh './gradlew wrapper --gradle-version 8.2.1'
                    sh './gradlew clean build --refresh-dependencies'
                }
                dir('/var/jenkins_home/workspace/wishme/server/user/') {
                    sh 'chmod +x gradlew'
                    sh './gradlew wrapper --gradle-version 8.2.1'
                    sh './gradlew clean build --refresh-dependencies'
                }
                dir('/var/jenkins_home/workspace/wishme/server/schoolLetter/') {
                    sh 'chmod +x gradlew'
                    sh './gradlew wrapper --gradle-version 8.2.1'
                    sh './gradlew clean build --refresh-dependencies'
                }
            }
        }

        stage('SSH-Docker') {
            steps {
                script {
                    sh """
                    pwd &&
                    cd /var/jenkins_home/workspace/docker && docker-compose -f docker-compose.wishme.yml up --build -d
                    """
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline succeeded"
        }
        failure {
            echo "Pipeline failed"
        }
    }
}

// def analyzeSonarQube(project) {
//     dir("server/${project}") {
//         sh 'chmod +x gradlew'
//         sh './gradlew wrapper --gradle-version=8.5'
//         sh './gradlew clean build sonarqube --warning-mode all'
//     }
// }
