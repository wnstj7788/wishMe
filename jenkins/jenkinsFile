pipeline {
    agent any
    stages {
        stage('Git Clone') {
            steps {
                script {
                    // Git Clone 스텝
                    git branch: 'master',
                    url: 'https://github.com/wnstj7788/wishMe.git',
                    credentialsId: 'JenkinsToGiitPass' // GitLab Credential ID
                }
            }
            post {
                success {
                    echo "Successfully Cloned Repository"
                }
                failure {
                    echo "Failed to Clone Repository"
                }
            }
        }

        stage('SonarQube analysis') {
                      steps {
                          withSonarQubeEnv('SonarQube Server') {
                               dir('server/myLetter') {
                                   sh 'chmod +x ./gradlew' // 실행 권한 추가
                                   sh './gradlew sonarqube \
                                         -Dsonar.projectKey=1q2w3e \
                                         -Dsonar.host.url=https://sonarqube.ssafy.com \
                                         -Dsonar.login=1q2w3e'
                                 }
                              }
                      }
                  }

        stage('Application') {
            steps {
                // application.yml 파일 복사
//                 sh 'cp /var/jenkins_home/workspace/applicationFile/user/application.yml /var/jenkins_home/workspace/wishMe/server/user/src/main/resources/'
                sh 'cp /var/jenkins_home/workspace/applicationFile/myletter/application.yml /var/jenkins_home/workspace/wishMe/server/myLetter/src/main/resources/'
//                 sh 'cp /var/jenkins_home/workspace/applicationFile/schoolLetter/application.yml /var/jenkins_home/workspace/wishMe/server/schoolLetter/src/main/resources/'
            }
        }

        stage('Build') {
            steps {
                // Gradle 빌드
//                 dir('/var/jenkins_home/workspace/wishMe/server/user/') {
//                     sh 'chmod +x gradlew'
//                     sh './gradlew clean build'
//                 }
                dir('/var/jenkins_home/workspace/wishMe/server/myLetter/') {
                    sh 'chmod +x gradlew'
                    sh './gradlew clean build'
                }
//                 dir('/var/jenkins_home/workspace/wishMe/server/schoolLetter/') {
//                     sh 'chmod +x gradlew'
//                     sh './gradlew clean build'
//                 }
            }
        }

        stage('ssh-docker') {
            steps {
                script {
                    sh """
                    cd /var/jenkins_home/workspace/dockerRun && docker-compose up --build -d
                    """
                }
            }
        }
    }

    post {
        success {
            echo "SSH and Docker commands succeeded"
        }
        failure {
            echo "SSH and Docker commands failed"
        }
    }
}
